FROM ubuntu:24.04

ARG DEBIAN_FRONTEND=noninteractive
ARG DOWNLOAD_URL  ## 如果需要继续用远程下载 IDMP，可保留；若改为本地包则忽略
ARG TARGETARCH     ## 由 buildx 自动注入 (amd64/arm64)

## 可选：本地文件名常量，避免重复写死版本号
ARG IDMP_PKG=tdengine-idmp-enterprise-linux.tar.gz

ARG TARGETARCH

## 优化：使用国内镜像源加速 apt（可选）
# RUN sed -i 's|http://archive.ubuntu.com|http://mirrors.aliyun.com|g' /etc/apt/sources.list.d/ubuntu.sources
RUN groupadd -r tdengine --gid=101 \
    && useradd -r -g tdengine --uid=101 --home-dir=/home/tdengine --shell=/bin/bash tdengine

## 优化：合并所有 apt 操作，使用 BuildKit 缓存挂载，去除调试工具（gdb/tmux/valgrind）
RUN --mount=type=cache,target=/var/cache/apt,sharing=locked \
    --mount=type=cache,target=/var/lib/apt,sharing=locked \
    apt-get update && apt-get install -y --no-install-recommends \
        ca-certificates \
        curl \
        wget \
        tar \
        bash \
        net-tools \
        openjdk-21-jre-headless \
        python3.12 \
        python3.12-venv \
        fontconfig \
        locales \
        tzdata \
        procps \
        netcat-openbsd \
        jq \
        rsync \
    && ln -fs /usr/bin/python3.12 /usr/bin/python3 \
    && ln -fs /usr/share/zoneinfo/UTC /etc/localtime \
    && echo "UTC" > /etc/timezone \
    && locale-gen en_US.UTF-8 \
    && rm -rf /var/lib/apt/lists/* /tmp/* /var/tmp/*

ENV TZ=UTC \
    LANG=en_US.UTF-8 \
    LC_ALL=en_US.UTF-8 \
    PIP_INDEX_URL=https://mirrors.aliyun.com/pypi/simple/ \
    PIP_TRUSTED_HOST=mirrors.aliyun.com

## 配置 pip 使用阿里云镜像源
RUN printf "[global]\nindex-url = https://mirrors.aliyun.com/pypi/simple/\ntrusted-host = mirrors.aliyun.com\ntimeout = 120\n" > /etc/pip.conf

## 优化：预先下载 arthas，利用缓存（放在安装包之前，避免频繁重建）
RUN --mount=type=cache,target=/root/.cache \
    mkdir -p /opt/arthas \
    && curl -fsSL -o /opt/arthas/arthas-boot.jar https://arthas.aliyun.com/arthas-boot.jar \
    && echo '#!/bin/sh\njava -jar /opt/arthas/arthas-boot.jar "$@"' > /usr/local/bin/arthas \
    && chmod +x /usr/local/bin/arthas

## 优化：合并 IDMP 和 TSDB 安装到一个 RUN，减少层数
RUN --mount=type=bind,source=.,target=/packages \
    set -eux; \
    # 复制安装包到临时目录
    cp /packages/${IDMP_PKG} /tmp/idmp.tar.gz; \
    # 安装 IDMP
    tar -xzf /tmp/idmp.tar.gz -C /tmp; \
    cd /tmp/tdengine-idmp-enterprise-*; \
    ./install.sh -s -n; \
    cd /; \
    rm -rf /tmp/tdengine-idmp-enterprise-* /tmp/idmp.tar.gz; \
    # 清理所有临时文件
    cd /; \
    rm -rf /tmp/*

## 优化：合并 COPY 和 chmod
COPY --chmod=755 entrypoint.it_monitoring.sh /entrypoint.sh

EXPOSE 6042

WORKDIR /root

ENTRYPOINT ["/entrypoint.sh"]

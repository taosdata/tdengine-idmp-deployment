services:
  tdengine-tsdb:
    image: tdengine/tsdb-ee:3.3.8.8
    container_name: tdengine-tsdb
    hostname: tdengine
    restart: always
    environment:
      TZ: "${TZ:-UTC}"
    ports:
      - "6030:6030"
      - "6041:6041"
      - "6060:6060"
    volumes:
      - tsdb_data:/var/lib/taos
      - tsdb_log:/var/log/taos
    networks:
      - taos_net
    healthcheck:
      test: ["CMD", "taos", "-h", "localhost", "-s", "show databases;"]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 30s

  tdengine-idmp:
    image: tdengine/idmp-ee:${IDMP_TAG:-latest}
    container_name: tdengine-idmp
    restart: always
    depends_on:
      tdengine-tsdb:
        condition: service_healthy
    environment:
      TZ: "${TZ:-UTC}"
      TSDB_URL: "http://tdengine-tsdb:6041"
      TDA_ANALYSIS_EVENT_URLS: "ws://tdengine-idmp:6042"
      QUARKUS_PROFILE: "${QUARKUS_PROFILE:-prod}"
      IDMP_URL: "${IDMP_URL:-http://localhost:6042}"
      TDA_AI_CONN_ZH: "${TDA_AI_CONN_ZH:-DeepSeek}"
      TDA_AI_CONN_EN: "${TDA_AI_CONN_EN:-OpenAI}"
      TDA_REST_BASE_PATH: "${TDA_REST_BASE_PATH:-}"
    ports:
      - "6034:6034"
      - "6038:6038"
      - "6042:6042"
    volumes:
      - idmp_data:/var/lib/taos
      - idmp_log:/var/log/taos
    networks:
      - taos_net
    healthcheck:
      test: [
        "CMD",
        "python3",
        "-c",
        "import urllib.request, socket; \
        [urllib.request.urlopen(f'http://localhost:{p}', timeout=5) for p in [6038, 6042]]; \
        [socket.create_connection(('localhost', p), timeout=1).close() for p in [6039, 6040]]"
      ]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 30s

networks:
  taos_net:
    driver: bridge

volumes:
  tsdb_data:
    driver: local
  tsdb_log:
    driver: local
  idmp_data:
    driver: local
  idmp_log:
    driver: local
